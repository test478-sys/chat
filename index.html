<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Whatsapp (Raymond Edition)</title>
  <style>
    :root{ --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#94a3b8; --brand:#22c55e; --me:#2563eb; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{ margin:0; font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:linear-gradient(180deg,#0b1220,#0f172a); color:var(--ink); display:flex; align-items:center; justify-content:center; }
    .app{ position:relative; width:min(920px,95vw); height:min(720px,92vh); background:var(--card); border:1px solid #1f2937; border-radius:18px; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,.35) }
    header{ display:flex; align-items:center; gap:.75rem; padding:12px 14px; border-bottom:1px solid #1f2937; background:rgba(255,255,255,.02) }
    header h1{ font-size:16px; margin:0 }
    .row{ margin-left:auto; display:flex; align-items:center; gap:.5rem }
    .pill{ display:inline-flex; align-items:center; gap:.5rem; background:#0b1220; border:1px solid #223049; padding:6px 10px; border-radius:999px; color:var(--muted); cursor:pointer }
    .pill button{ all:unset; cursor:pointer; font-size:12px; padding:4px 8px; background:var(--brand); color:#fff; border-radius:10px; font-weight:700 }

    /* Toggle switch */
    .switch{ position:relative; display:inline-flex; align-items:center; gap:.5rem; user-select:none; font-size:12px; color:var(--muted); padding:4px 6px; border-radius:999px; border:1px solid #223049; background:#0b1220 }
    .switch input{ appearance:none; width:36px; height:20px; background:#111827; border:1px solid #223049; border-radius:999px; position:relative; outline:none; cursor:pointer; transition:.2s }
    .switch input:after{ content:""; position:absolute; top:1px; left:1px; width:16px; height:16px; background:#374151; border-radius:50%; transition:.2s }
    .switch input:checked{ background:#16a34a; border-color:#15803d }
    .switch input:checked:after{ left:18px; background:#ecfdf5 }
    .switch .state{ font-weight:700; color:#bbf7d0 }
    .switch .off{ color:#9ca3af }

    #roomBar{ padding:8px 14px; font-size:12px; color:var(--muted); border-bottom:1px dashed #1f2937 }
    #roomBar code{ background:#0b1220; padding:2px 6px; border-radius:8px; color:#bbf7d0 }

    #messages{ flex:1; overflow:auto; padding:16px; display:flex; flex-direction:column; gap:10px; scroll-behavior:smooth }
    .msg{ display:flex; gap:10px; align-items:flex-end; max-width:86% }
    .msg.me{ margin-left:auto; flex-direction:row-reverse }   /* My messages on the right */
    .bubble{ padding:10px 12px; background:#0b1220; border:1px solid #223049; border-radius:14px; white-space:pre-wrap; word-break:break-word; position:relative }
    .msg.me .bubble{ background:var(--me); border-color:#1e40af; color:#fff }
    .bubble.deleted{ font-style:italic; opacity:.8 }
    .meta{ font-size:11px; color:#94a3b8; margin-top:4px }
    .msg.me .meta{ text-align:right }
    .avatar{ width:30px; height:30px; border-radius:50%; background:#0b1220; border:1px solid #223049; display:grid; place-items:center; font-weight:700; color:#d1fae5 }
    .msg.me .avatar{ background:#dbeafe; color:#1e3a8a; border-color:#93c5fd }

    /* Per-message actions */
    .actions{ display:flex; align-items:center; gap:6px; margin-top:2px }
    .menuWrap{ position:relative; }
    .menuBtn{ background:transparent; border:0; color:#9ca3af; cursor:pointer; padding:4px; border-radius:8px }
    .menuBtn:hover{ background:#111827; color:#e5e7eb }
    .menu{ position:absolute; right:0; bottom:26px; display:none; background:#0b1220; border:1px solid #223049; border-radius:10px; min-width:190px; box-shadow:0 14px 40px rgba(0,0,0,.4); z-index:10 }
    .menu.open{ display:block }
    .menu ul{ list-style:none; margin:0; padding:6px }
    .menu li button{ all:unset; display:block; width:100%; text-align:left; padding:8px 10px; border-radius:8px; cursor:pointer; color:#e5e7eb; font-size:13px }
    .menu li button:hover{ background:#111827 }
    .sep{ height:1px; margin:6px 0; background:#1f2937 }

    form{ display:flex; gap:10px; padding:12px; border-top:1px solid #1f2937; background:rgba(255,255,255,.03) }
    input[type=text]{ flex:1; padding:14px 12px; border-radius:12px; background:#0b1220; color:#e5e7eb; border:1px solid #223049 }
    input[type=text]::placeholder{ color:#6b7280 }
    button.send{ padding:12px 16px; border-radius:12px; background:var(--brand); color:#fff; border:0; font-weight:800; cursor:pointer }
    button.send:disabled{ opacity:.5; cursor:not-allowed }

    .foot{ padding:8px 14px; font-size:11px; color:#6b7280; text-align:center }
    .toast{ position:fixed; bottom:16px; right:16px; background:#111827; border:1px solid #374151; color:#e5e7eb; padding:10px 12px; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.35); font-size:13px; display:none }
    .toast .row{ display:flex; align-items:center; gap:10px }
    .toast button{ all:unset; background:#2563eb; color:#fff; padding:6px 10px; border-radius:8px; cursor:pointer; font-weight:700 }

    /* Online panel */
    #onlineBtn{ cursor:pointer }
    #onlinePanel{ position:absolute; right:12px; top:56px; width:220px; max-height:50vh; overflow:auto; background:#0b1220; border:1px solid #223049; border-radius:12px; padding:8px; display:none; box-shadow:0 14px 40px rgba(0,0,0,.4) }
    #onlinePanel h3{ margin:6px 6px 8px; font-size:12px; color:#9ca3af; font-weight:600 }
    #onlineList{ list-style:none; margin:0; padding:0 }
    #onlineList li{ display:flex; align-items:center; gap:8px; padding:6px 8px; border-radius:8px; color:#e5e7eb }
    #onlineList li:hover{ background:#0f172a }
    .dot{ width:8px; height:8px; border-radius:50%; background:#22c55e; box-shadow:0 0 0 3px rgba(34,197,94,.15) }
    .meTag{ margin-left:auto; font-size:10px; color:#93c5fd }

    /* Stats for Nerds panel */
    #nerdPanel{
      position:absolute; right:12px; bottom:56px; width:320px; max-height:60vh; overflow:auto;
      background:#0b1220; border:1px solid #223049; border-radius:12px; padding:10px; display:none;
      box-shadow:0 14px 40px rgba(0,0,0,.4)
    }
    #nerdPanel h3{ margin:0 0 6px; font-size:13px; color:#e5e7eb }
    #nerdPanel .row{ display:flex; justify-content:space-between; gap:10px; margin:4px 0; font-size:12px; color:#cbd5e1 }
    #nerdPanel .mono{ font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; color:#93c5fd; word-break:break-all }
    #nerdPanel hr{ border:0; border-top:1px solid #223049; margin:8px 0 }
    #nerdPanel small{ color:#94a3b8 }
  </style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <h1>Whatsapp (Raymond Edition)</h1>
      <div class="row">
        <div id="onlineBtn" class="pill" title="Who's online">
          <span>ðŸŸ¢ Online</span>
          <strong id="onlineCount">0</strong>
        </div>
        <label class="switch" title="Desktop notifications">
          <input type="checkbox" id="notifyChk" />
          <span>ðŸ”” <span id="notifyText" class="off">Off</span></span>
        </label>
        <div class="pill" id="userPill">
          <span id="userLabel">â€”</span>
          <button id="editName">Edit</button>
        </div>
        <div id="nerdBtn" class="pill" title="Stats for Nerds">ðŸ“Š Stats</div>
      </div>
    </header>

    <div id="roomBar">Room: <code id="roomName">general</code></div>

    <div id="onlinePanel" role="dialog" aria-modal="false">
      <h3>Online now</h3>
      <ul id="onlineList"></ul>
    </div>

    <main id="messages" aria-live="polite" aria-busy="true"></main>

    <form id="form" autocomplete="off">
      <input id="input" type="text" placeholder="Type a messageâ€¦ (Enter to send)" maxlength="2000" required />
      <button class="send" id="sendBtn" type="submit">Send</button>
    </form>

    <div id="nerdPanel" role="dialog" aria-modal="false" aria-live="polite"></div>

    <div class="foot">Powered by Supabase.</div>
  </div>

  <div class="toast" id="toast"><span id="toastMsg">Saved your new name.</span> <button id="toastUndo" style="display:none">Undo</button></div>

  <script type="module">
    // --- Version & Config ---
    const APP_VERSION = 'v0.9.1'; // bumped version
    const SUPABASE_URL = "https://hlamttqxuifqlnfamkvw.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhsYW10dHF4dWlmcWxuZmFta3Z3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNDE2ODEsImV4cCI6MjA3MDcxNzY4MX0.4pLNZkGDYVjRBNudJ0OtszQC9fdvcHD1kgHB8W0bNJg";

    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: false } });

    // ---- App State ----
    const params = new URLSearchParams(location.search);
    const room = (params.get('room') || 'general').trim().slice(0, 64).toLowerCase();
    document.getElementById('roomName').textContent = room || 'general';

    const els = {
      messages: document.getElementById('messages'),
      input:    document.getElementById('input'),
      form:     document.getElementById('form'),
      sendBtn:  document.getElementById('sendBtn'),
      userLbl:  document.getElementById('userLabel'),
      editName: document.getElementById('editName'),
      toast:    document.getElementById('toast'),
      toastMsg: document.getElementById('toastMsg'),
      toastUndo: document.getElementById('toastUndo'),
      notifyChk: document.getElementById('notifyChk'),
      notifyText: document.getElementById('notifyText'),
      onlineBtn: document.getElementById('onlineBtn'),
      onlinePanel: document.getElementById('onlinePanel'),
      onlineList: document.getElementById('onlineList'),
      onlineCount: document.getElementById('onlineCount'),
      nerdBtn: document.getElementById('nerdBtn'),
      nerdPanel: document.getElementById('nerdPanel'),
    };

    // Identity & prefs
    const uidKey = 'minichat_uid';
    const nameKey = 'minichat_name';
    const notifyKey = 'minichat_notify';
    const hiddenKey = `minichat_hidden_${room}`;

    function nanoId(){return crypto.getRandomValues(new Uint8Array(8)).reduce((a,b)=>a+('0'+b.toString(16)).slice(-2),'')}
    let uid = localStorage.getItem(uidKey) || (()=>{const v=nanoId(); localStorage.setItem(uidKey,v); return v;})();
    let name = (localStorage.getItem(nameKey) || '').trim();

    async function askName(initial=false){
      const prev = name || '';
      const next = (prompt('Pick a username (2â€“24 chars):', prev) || '').trim();
      if(next && next.length>=2 && next.length<=24){
        name = next; localStorage.setItem(nameKey, name); els.userLbl.textContent = name;
        if(!initial){ toast('Saved your new name.'); trackPresence(); refreshOwnNameInHistory(); }
      } else if(initial && !prev){
        name = 'Guest-' + uid.slice(-4); localStorage.setItem(nameKey, name); els.userLbl.textContent = name;
      }
    }
    await askName(true);
    els.editName.addEventListener('click', ()=>askName(false));
    els.userLbl.textContent = name;

    // Local "delete for me" store
    const getHiddenSet = () => { try { return new Set(JSON.parse(localStorage.getItem(hiddenKey)||'[]')); } catch { return new Set(); } };
    const addHidden = (id) => { const s=getHiddenSet(); s.add(id); localStorage.setItem(hiddenKey, JSON.stringify([...s])); };
    const removeHidden = (id) => { const s=getHiddenSet(); s.delete(id); localStorage.setItem(hiddenKey, JSON.stringify([...s])); };

    // Toast / Undo
    let toastTimer = null, lastHiddenUndoId = null;
    function toast(msg, {undoId=null, ttl=1800}={}){
      els.toastMsg.textContent = msg;
      els.toastUndo.style.display = undoId ? 'inline-block' : 'none';
      els.toast.style.display='block';
      lastHiddenUndoId = undoId;
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>{ els.toast.style.display='none'; els.toastUndo.style.display='none'; lastHiddenUndoId=null; }, ttl);
    }
    els.toastUndo.addEventListener('click', ()=>{
      if(!lastHiddenUndoId) return;
      removeHidden(lastHiddenUndoId);
      const node = els.messages.querySelector(`.msg[data-id="${cssEscape(lastHiddenUndoId)}"]`);
      if(node) node.style.display='';
      els.toast.style.display='none'; els.toastUndo.style.display='none'; lastHiddenUndoId=null;
    });

    // Notifications
    const supportsNotif = 'Notification' in window;
    function syncNotifyUI(){
      const on = localStorage.getItem(notifyKey) === 'on';
      els.notifyChk.checked = on && Notification.permission === 'granted';
      els.notifyChk.disabled = !supportsNotif || Notification.permission === 'denied';
      els.notifyText.textContent = (els.notifyChk.checked ? 'On' : 'Off');
      els.notifyText.className = els.notifyChk.checked ? 'state' : 'off';
      if(!supportsNotif){ els.notifyText.textContent = 'N/A'; }
    }
    syncNotifyUI();
    els.notifyChk.addEventListener('change', async () => {
      if(els.notifyChk.checked){
        if(!supportsNotif){ alert('Your browser does not support Notifications.'); syncNotifyUI(); return; }
        if(Notification.permission === 'default'){
          const res = await Notification.requestPermission();
          if(res !== 'granted'){ els.notifyChk.checked = false; syncNotifyUI(); return; }
        }
        if(Notification.permission === 'denied'){
          alert('Notifications are blocked in your browser settings.');
          els.notifyChk.checked = false; syncNotifyUI(); return;
        }
        localStorage.setItem(notifyKey, 'on'); syncNotifyUI();
        try{ const n = new Notification('Whatsapp (Raymond Edition) notifications on', { body: `Room #${room}` }); n.onclick = ()=>{ window.focus(); n.close(); }; }catch{}
      } else {
        localStorage.setItem(notifyKey, 'off'); syncNotifyUI(); toast('Notifications off');
      }
    });

    // Presence
    let presenceStatus = 'INIT';
    const presence = supabase.channel('presence:'+room, { config: { presence: { key: uid } } });
    function renderPresence(){
      const state = presence.presenceState();
      const users = Object.entries(state).map(([_, metas]) => metas[0]).filter(Boolean);
      users.sort((a,b)=> (a.uid===uid?-1:b.uid===uid?1: (a.username||'').localeCompare(b.username||'')));
      els.onlineCount.textContent = users.length;
      els.onlineList.innerHTML = users.map(u => `
        <li><span class="dot"></span><span>${escapeHtml(u.username||'unknown')}</span>${u.uid===uid?'<span class="meTag">you</span>':''}</li>
      `).join('');
    }
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
    async function trackPresence(){ try{ await presence.track({ uid, username: name || ('Guest-'+uid.slice(-4)), room, online_at: new Date().toISOString() }); }catch{} }
    presence.on('presence', { event: 'sync'  }, renderPresence)
            .on('presence', { event: 'join'  }, renderPresence)
            .on('presence', { event: 'leave' }, renderPresence);
    await presence.subscribe((status) => { presenceStatus = status; if(status === 'SUBSCRIBED') trackPresence(); });

    const onlineBtn = document.getElementById('onlineBtn');
    const onlinePanel = document.getElementById('onlinePanel');
    onlineBtn.addEventListener('click', (e)=>{ e.stopPropagation(); const on = onlinePanel.style.display === 'block'; onlinePanel.style.display = on ? 'none' : 'block'; if(!on) renderPresence(); });
    document.addEventListener('click', (e)=>{ if(!onlinePanel.contains(e.target) && e.target !== onlineBtn){ onlinePanel.style.display='none'; } });
    window.addEventListener('storage', (e)=>{ if(e.key===nameKey){ name = e.newValue; trackPresence(); refreshOwnNameInHistory(); } });
    setInterval(()=>{ trackPresence(); }, 30_000);

    // ---- Data load ----
    const DELETED_SENTINEL = '__WRE_DELETED__';  // stored in DB; UI shows friendly text

    async function loadInitial(){
      let { data, error } = await supabase
        .from('messages')
        .select('id, text, username, uid, room, created_at, updated_at')
        .eq('room', room)
        .order('created_at', { ascending: true })
        .limit(500);

      if(error && /column .*updated_at/i.test(error.message)){
        ({ data, error } = await supabase
          .from('messages')
          .select('id, text, username, uid, room, created_at')
          .eq('room', room)
          .order('created_at', { ascending: true })
          .limit(500));
      }
      if(error){ alert('Load failed: '+ error.message); return; }

      els.messages.innerHTML = '';
      for(const m of (data || [])){
        appendMessage({
          id: m.id, text: m.text, username: m.username, author: m.uid,
          at: new Date(m.created_at),
          uat: m.updated_at ? new Date(m.updated_at) : null
        });
      }
      els.messages.scrollTop = els.messages.scrollHeight + 9999;
      els.messages.setAttribute('aria-busy','false');
    }
    await loadInitial();

    // ---- Realtime ----
    let roomStatus = 'INIT';
    const channel = supabase
      .channel('room:'+room)
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `room=eq.${room}` }, (payload) => {
        const m = payload.new;
        appendMessage({ id: m.id, text: m.text, username: m.username, author: m.uid, at: new Date(m.created_at), uat: m.updated_at?new Date(m.updated_at):null });
        els.messages.scrollTop = els.messages.scrollHeight + 9999;

        if(localStorage.getItem(notifyKey)==='on' && 'Notification' in window && Notification.permission==='granted' && m.uid !== uid && (!document.hasFocus() || document.visibilityState==='hidden')){
          try{
            const n = new Notification(`${m.username} â€” #${room}`, { body: (m.text||'').slice(0,120), tag:`wre-${room}`, renotify:true });
            n.onclick = ()=>{ window.focus(); n.close(); };
          }catch{}
        }
      })
      .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'messages', filter: `room=eq.${room}` }, (payload) => {
        const m = payload.new;
        updateMessageDom({ id: m.id, text: m.text, username: m.username, author: m.uid, at: new Date(m.created_at), uat: m.updated_at?new Date(m.updated_at):null });
      })
      .subscribe((status)=>{ roomStatus = status; });

    // ---- DOM helpers ----
    function appendMessage({id, text, username, author, at, uat}){
      const mine = (author === uid);
      const hidden = getHiddenSet().has(id);

      const wrap = document.createElement('div');
      wrap.className = 'msg' + (mine ? ' me' : '');
      wrap.dataset.id = id;
      wrap.dataset.uid = author;
      wrap.dataset.createdAt = at.toISOString();

      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.textContent = (username||'?').slice(0,2).toUpperCase();

      const stack = document.createElement('div');
      stack.style.maxWidth = '100%';

      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      const isDeleted = text === DELETED_SENTINEL;
      bubble.classList.toggle('deleted', isDeleted);
      bubble.textContent = isDeleted ? (mine ? 'You deleted this message' : 'This message was deleted') : (text ?? '');

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = buildMeta(username, at, uat, !isDeleted);

      // Actions (â‹¯)
      const actions = document.createElement('div');
      actions.className = 'actions';
      const menuWrap = document.createElement('div'); menuWrap.className = 'menuWrap';
      const btn = document.createElement('button'); btn.className = 'menuBtn'; btn.title = 'More'; btn.setAttribute('aria-haspopup','menu'); btn.textContent='â‹¯';
      const menu = document.createElement('div'); menu.className = 'menu';
      const ul = document.createElement('ul');

      // Delete for me (any message)
      const liHide = document.createElement('li');
      const btnHide = document.createElement('button');
      btnHide.textContent = 'Delete for me';
      btnHide.addEventListener('click', ()=>{
        menu.classList.remove('open');
        addHidden(id);
        wrap.style.display='none';
        toast('Message hidden', { undoId: id, ttl: 4500 });
      });
      liHide.appendChild(btnHide); ul.appendChild(liHide);

      // Author-only actions (Edit / Delete for everyone)
      if(mine && !isDeleted){
        const liEdit = document.createElement('li');
        const btnEdit = document.createElement('button');
        btnEdit.textContent = 'Edit';
        btnEdit.addEventListener('click', async ()=>{
          menu.classList.remove('open');
          const createdMs = Date.parse(wrap.dataset.createdAt);
          const within15 = (Date.now() - createdMs) <= 15*60*1000;
          if(!within15){ alert('You can only edit within 15 minutes.'); return; }
          const current = bubble.textContent || '';
          const next = (prompt('Edit your message:', current) ?? '').trim();
          if(!next || next === current) return;
          try{ await editMessage(id, next); }catch(err){ alert('Edit failed: ' + (err.message||err)); }
        });
        liEdit.appendChild(btnEdit); ul.appendChild(liEdit);

        const sep = document.createElement('div'); sep.className='sep'; ul.appendChild(sep);

        const liDelAll = document.createElement('li');
        const btnDelAll = document.createElement('button');
        btnDelAll.textContent = 'Delete for everyone';
        btnDelAll.addEventListener('click', async ()=>{
          menu.classList.remove('open');
          if(!confirm('Delete this message for everyone?')) return;
          try{ await deleteForEveryone(id); }catch(err){ alert('Delete failed: ' + (err.message||err)); }
        });
        liDelAll.appendChild(btnDelAll); ul.appendChild(liDelAll);
      }

      menu.appendChild(ul);
      menuWrap.appendChild(btn);
      menuWrap.appendChild(menu);
      actions.appendChild(menuWrap);

      btn.addEventListener('click', (e)=>{ e.stopPropagation(); closeAllMenus(); menu.classList.add('open'); });
      document.addEventListener('click', ()=>{ menu.classList.remove('open'); });

      stack.appendChild(bubble);
      stack.appendChild(meta);
      stack.appendChild(actions);

      wrap.appendChild(avatar);
      wrap.appendChild(stack);
      els.messages.appendChild(wrap);

      if(hidden) wrap.style.display='none';
    }

    function updateMessageDom({id, text, username, author, at, uat}){
      const wrap = els.messages.querySelector(`.msg[data-id="${cssEscape(id)}"]`);
      if(!wrap){ appendMessage({ id, text, username, author, at, uat }); return; }

      const mine = (wrap.dataset.uid === uid);
      wrap.classList.toggle('me', mine);

      const bubble = wrap.querySelector('.bubble');
      const meta = wrap.querySelector('.meta');
      const isDeleted = (text === DELETED_SENTINEL);

      if(bubble){
        bubble.classList.toggle('deleted', isDeleted);
        bubble.textContent = isDeleted ? (mine ? 'You deleted this message' : 'This message was deleted') : (text ?? '');
      }
      if(meta){ meta.textContent = buildMeta(username, at, uat, !isDeleted); }
    }

    function buildMeta(username, at, uat, showEdited){
      const time = fmtTime(at);
      const edited = (uat && +uat > +at) ? ' (edited)' : '';
      return `${username || 'unknown'} â€¢ ${time}${showEdited ? edited : ''}`;
    }

    function refreshOwnNameInHistory(){
      document.querySelectorAll(`.msg[data-uid="${cssEscape(uid)}"] .meta`).forEach(meta=>{
        meta.textContent = meta.textContent.replace(/^[^â€¢]+/, name || 'unknown');
      });
      document.querySelectorAll(`.msg[data-uid="${cssEscape(uid)}"] .avatar`).forEach(av=>{
        av.textContent = (name||'?').slice(0,2).toUpperCase();
      });
    }

    // --- RPC-first edit/delete (with fallback if RLS is open) ---
    async function editMessage(id, nextText){
      // Try RPC first (recommended with RLS)
      let { error } = await supabase.rpc('wre_edit_message', {
        p_id: String(id),
        p_uid: uid,
        p_text: nextText
      });

      // Fallback to direct update if RPC not installed / you opened RLS
      if (error) {
        const resp = await supabase
          .from('messages')
          .update({ text: nextText })
          .eq('id', id)
          .eq('uid', uid);
        error = resp.error;
      }

      if (error) {
        console.error('Edit failed:', error);
        alert('Edit failed. Did you run the SQL to install wre_edit_message?');
        throw error;
      }

      // If no updated_at trigger, still show "(edited)"
      markEditedLocally(id);
    }

    async function deleteForEveryone(id){
      // RPC first (fix for RLS)
      let { error } = await supabase.rpc('wre_mark_deleted', {
        p_id: String(id),
        p_uid: uid,
        p_text: DELETED_SENTINEL
      });

      // Fallback to direct update if RPC not installed / RLS loosened
      if (error) {
        const resp = await supabase
          .from('messages')
          .update({ text: DELETED_SENTINEL })
          .eq('id', id)
          .eq('uid', uid);
        error = resp.error;
      }

      if (error) {
        console.error('Delete for everyone failed:', error);
        alert('Delete for everyone failed. Did you run the SQL to install wre_mark_deleted?');
        throw error;
      }
    }

    function markEditedLocally(id){
      const wrap = els.messages.querySelector(`.msg[data-id="${cssEscape(id)}"]`);
      if(!wrap) return;
      const meta = wrap.querySelector('.meta');
      if(!meta) return;
      if(!/\(edited\)\s*$/.test(meta.textContent)) meta.textContent += ' (edited)';
    }

    // Send message
    els.form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const text = (els.input.value || '').trim();
      if(!text) return;
      els.sendBtn.disabled = true;
      try{
        const { error } = await supabase.from('messages').insert({ text, username: name || ('Guest-' + uid.slice(-4)), uid, room });
        if(error) throw error;
        els.input.value = '';
        els.messages.scrollTop = els.messages.scrollHeight + 9999;
      } catch(err){ alert('Send failed: '+ err.message); }
      finally { els.sendBtn.disabled = false; }
    });

    // Keyboard UX: Enter to send, Shift+Enter for newline
    els.input.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); els.form.requestSubmit(); } });

    // Clean up when leaving
    addEventListener('beforeunload', ()=>{ try{ supabase.removeChannel(channel); supabase.removeChannel(presence); }catch{} });

    // Auto-scroll on focus
    addEventListener('visibilitychange',()=>{ if(document.visibilityState==='visible'){ els.messages.scrollTop = els.messages.scrollHeight + 9999; } });

    // Utils
    function fmtTime(d){ try{ return new Intl.DateTimeFormat(undefined,{hour:'2-digit',minute:'2-digit'}).format(d); }catch{ return '' } }
    function cssEscape(s){ return String(s).replace(/["\\]/g, '\\$&'); }
    function closeAllMenus(){ document.querySelectorAll('.menu.open').forEach(m => m.classList.remove('open')); }

    // ===== Stats for Nerds =====
    let nerdTimer = null, lastLatencyMs = null;
    els.nerdBtn.addEventListener('click', async (e)=>{
      e.stopPropagation();
      const on = els.nerdPanel.style.display === 'block';
      if(on){
        els.nerdPanel.style.display = 'none';
        clearInterval(nerdTimer); nerdTimer = null;
        return;
      }
      await renderNerdStats(); // initial render
      els.nerdPanel.style.display = 'block';
      clearInterval(nerdTimer);
      nerdTimer = setInterval(renderNerdStats, 3000);
    });

    document.addEventListener('click', (e)=>{
      if(!els.nerdPanel.contains(e.target) && e.target !== els.nerdBtn){
        els.nerdPanel.style.display = 'none';
        clearInterval(nerdTimer); nerdTimer = null;
      }
    });

    async function renderNerdStats(){
      // Measure latency (non-blocking)
      measureLatency().catch(()=>{});

      const hiddenCount = getHiddenSet().size;
      const msgCount = els.messages.querySelectorAll('.msg').length;

      const presState = presence.presenceState();
      const presList = Object.entries(presState).map(([k, metas])=>{
        const m = metas?.[0] || {};
        return `â€¢ <span class="mono">${k}</span> â€” ${escapeHtml(m.username||'unknown')}`;
      }).join('<br>') || '(none)';

      els.nerdPanel.innerHTML = `
        <h3>ðŸ“Š Stats for Nerds</h3>
        <div class="row"><span>Version</span><span class="mono">${APP_VERSION}</span></div>
        <div class="row"><span>UID</span><span class="mono">${uid}</span></div>
        <div class="row"><span>Username</span><span class="mono">${escapeHtml(name)}</span></div>
        <div class="row"><span>Room</span><span class="mono">${room}</span></div>
        <div class="row"><span>Messages loaded</span><span class="mono">${msgCount}</span></div>
        <div class="row"><span>Hidden (for me)</span><span class="mono">${hiddenCount}</span></div>
        <div class="row"><span>Presence status</span><span class="mono">${presenceStatus}</span></div>
        <div class="row"><span>Room channel</span><span class="mono">${roomStatus}</span></div>
        <div class="row"><span>Latency</span><span class="mono">${lastLatencyMs==null?'â€”':(lastLatencyMs+' ms')}</span></div>
        <hr>
        <div><small>Online users</small><br>${presList}</div>
        <hr>
        <div class="row"><span>Project</span><span class="mono">${SUPABASE_URL.replace(/^https?:\/\//,'')}</span></div>
        <div class="row"><span>Anon key</span><span class="mono">${SUPABASE_ANON_KEY.slice(0,10)}â€¦</span></div>
        <div class="row"><span>Updated</span><span class="mono">${new Date().toLocaleString()}</span></div>
      `;
    }

    async function measureLatency(){
      const url = `${SUPABASE_URL}/auth/v1/health`;
      const t0 = performance.now();
      try{
        const r = await fetch(url, { mode:'cors', cache:'no-store' });
        if(!r.ok) throw new Error('bad');
        lastLatencyMs = Math.max(0, Math.round(performance.now() - t0));
      }catch{
        lastLatencyMs = null; // show as â€”
      }
    }
    // ============================
  </script>
</body>
</html>
